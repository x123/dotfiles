#!/usr/bin/env bash
set -xeuo pipefail

if which darwin-rebuild
then
  echo "Found darwin-rebuild at $(which darwin-rebuild)"
  pushd ~/.dotfiles || exit 1
  if darwin-rebuild -v build --flake .#
  then
    nvd diff /run/current-system ./result
  fi
  popd || exit 1
elif which nixos-rebuild
then
  echo "Found nixos-rebuild at $(which nixos-rebuild)"
  pushd ~/.dotfiles || exit 1
  if nixos-rebuild -v build --flake .#
  then
    nvd diff /run/current-system ./result
  fi
  popd || exit 1
else
  echo "Error: Could not find nixos-rebuild or darwin-rebuild ... Bailing out!"
  exit 1
fi
