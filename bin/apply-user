#!/usr/bin/env bash
set -xeuo pipefail

if which scutil
then
  HOSTNAME=$(scutil --get LocalHostName)
else
  HOSTNAME=$(hostname -s)
fi

if [ ! "$(whoami)" ]
then
  echo "Error: Not able to determine USER ... Bailing out!";
  exit 1;
else
  USER=$(whoami)
fi

if [ -z "${HOSTNAME}" ]
then
  echo "Error: Not able to determine HOSTNAME ... Bailing out!";
  exit 1;
fi

echo "${USER}-${HOSTNAME}"
if nix build -v .#homeManagerConfigurations."${USER}"-"${HOSTNAME}".activationPackage
then
    ./result/activate;
else
    echo "Error: Build above failed, not running ./result/activate";
    exit 1;
fi
