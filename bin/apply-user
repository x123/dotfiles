#!env bash
# shellcheck disable=SC2239
set -xeuo pipefail

if which scutil
then
  HOSTNAME=$(scutil --get LocalHostName)
else
  HOSTNAME=$(hostname -s)
fi

if [ ! "$(whoami)" ]
then
	echo "Error: Not able to determine USER ... Bailing out!";
	exit 1;
else
  USER=$(whoami)
fi

if [ -z "${HOSTNAME}" ]
then
  echo "Error: Not able to determine HOSTNAME ... Bailing out!";
  exit 1;
fi

echo "${USER}-${HOSTNAME}"
pushd ~/.dotfiles || exit 1
if nix build -v .#homeManagerConfigurations."${USER}"-"${HOSTNAME}".activationPackage
then
    ./result/activate;
    popd || exit 1
else
    echo "Error: Build above failed, not running ./result/activate";
    popd || exit 1
    exit 1;
fi
